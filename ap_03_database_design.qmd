# Data model {#sec-erds}

```{r}
library(dplyr)
library(tibble)
library(gt)
library(gtExtras)
```

The following diagrams demonstrate one way in which the data model defined in this manual can be structured. The diagrams only deal with the data themselves - security, user management, change tracking and other helper functionalities are left out for clarity. The model is optimised to highlight the relationships between the various data points and contains some structures that support the controlled vocabulary lists, but is not optimised for performance.

## Helper tables

### Measurement type

Some numeric parameters require a separate specification for types of missing data (e.g. aspect at the site, @sec-pr-aspect). These codes are built in to most categorical code lists in this standard (where it makes sense to include them). For numeric data, a companion text column is required. It is generally expected that it will be populated in a semi-automated manner - for each parameter, it should default to [NR]{.ceg}, and be automatically updated to [NM]{.ceg} if a value is supplied. Users may also update to [ND]{.ceg} as needed.

```{r}
#| label: tbl-missing
#| tbl-cap: "Data record type"

dat_ss_eventt <-
  tribble(~Code, ~Name,
            'NM', 'Parameter was recorded normally',
            'ND', 'Parameter could not be reliably determined or does not apply',
            'NR', 'Parameter was not recorded')

tbl_ss_eventt <- gt(dat_ss_eventt) |>
   tab_options(
    column_labels.font.weight = 'bold', 
    heading.title.font.weight = 'bold',
    table.align = 'center',
    table.width = '85%'
  ) |>
  tab_style(style = list(cell_text(color  = 'red', 
                                   weight = 'bold',
                                   align  = 'center')),
            locations = cells_body(columns = 1)) |>
  cols_width(Code ~pct(10))

tbl_ss_eventt
```


## Soil Setting {#sec-erd-setting}

```{mermaid}
%%| fig-cap: "Overview - main tables only"

erDiagram
  site ||--|| location : "has one"
  location ||--o{ site_events : "may have some"
  site ||--|| landscape : "has one"
  landscape ||--|{ landform : "has at least one"
  

```

```{mermaid}
%%| fig-cap: "Overview - including support tables"

erDiagram
  site ||--|| location : "has one"
  location ||--o{ siteEvents : "may have some"
  sitePurposes }|--|{ site : "code comes from"
  siteSelMethods }|--|{ site : "code comes from"
  siteEventTypes  }|--|{ siteEvents : "code comes from"
  site ||--|| landscape : "has one"
  landscape ||--|{ landform : "has at least one"
  

```


```{mermaid}
%%| fig-cap: "Details"

erDiagram
  site ||--|| location : "has one"
  location ||--o{ siteEvents : "may have some"
  sitePurposes }|--|{ site : "code comes from"
  siteSelMethods }|--|{ site : "code comes from"
  siteEventTypes  }|--|{ siteEvents : "code comes from"
  site ||--|| landscape : "has one"
  landscape ||--|{ landform : "has at least one"
  lscapeTypes }|--|{ landscape : "code comes from"
  
  site {
  id siteIdentifier "Section 3.1"
  text author "Section 3.2"
  date visitDate "Section 3.4"
  catu sitePurposeCode "Section 3.5"
  catu siteSelMethodCode "Section 3.6"
  }
  
  
  
  siteSelMethods {
  id siteSelMethodIdentifier
  catu siteSelMethodCode "Table 3.2"
  text siteSelMethodName "Table 3.2"
  text siteSelMethodDesc "Table 3.2" 
  }
  
  location {
  id siteIdentifier "Section 3.1"
  geo locationXY "Sections 3.3, 4.1.1"
  number elevationAbsZ "Section 4.1.1"
  number errorXY "Section 4.1.2"
  number errorZ "Section 4.1.2"
  catu elevMethod "Section 4.1.3"
  catu GNSSType "Section 4.1.4"
  number elevationRelZ "Section 4.2.1"
  text triangulationNotes "Section 4.2.2"
  text locationDesc "Section 4.2.3"
  catu adminRC "Section 4.2.4 - Optional"
  catu adminDC "Section 4.2.4 - Optional"
  }
  
  siteEvents {
  id siteIdentifier "Section 3.1"
  id eventIdentifier 
  catu siteEventCode "Section 4.2.5"
  integer[0-Inf] daysSinceEvent "Section 4.2.5"
}

 siteEventTypes {
  id siteEventIdentifier
  catu siteEventCode "Table 4.3"
  text siteEventName "Table 4.3"
  text siteEventDesc "Table 4.3"
  }
  
  landscape {
  id siteIdentifier "Section 3.1"
  catu lscapeTypeCode "Section 5.1.4"
  number[0-Inf] lscapeReliefMedian "Section 5.1.1"
  number[0-90]  lscapeSlopeMedian "Section 5.1.2"
  number[0-Inf] lscapeSlopeRangeLo "Section 5.1.2"
  number[0-Inf] lscapeSlopeRangeHi "Section 5.1.2"
  }

  lscapeTypes {
  id lscapeTypeIdentifier
  catu lscapeTypeCode "Table TBA"
  text lscapeTypeName "Table TBA"
  }
  
  landform {
  id siteIdentifier "Section 3.1"
  catu lformTypeCode "Section 5.1.4"
  number[0-Inf] lformReliefMedian "Section 5.1.1"
  number[0-90]  lformSlopeMedian "Section 5.1.2"
  number[0-Inf] lformSlopeRangeLo "Section 5.1.2"
  number[0-Inf] lformSlopeRangeHi "Section 5.1.2"
  }



```

## Profile data {#sec-erd-profile}

```{mermaid}
%%| fig-cap: "Overview - main tables only"

erDiagram
  site ||--o{ disturbances : "may have some"

```


```{mermaid}
%%| fig-cap: "Profile overview - including support tables"

erDiagram
  site ||--|{ disturbances : "has one or more"
  disturbances }|--|{ disturbance_types : "code comes from"
  disturbances }|--|{ disturbance_ages : "code comes from"
  site }|--|{ site_purposes : "code comes from"
  site }|--|{ site_selection_methods : "code comes from"
  site }|--|{ site_exposure_types : "code comes from"
  site }|--|{ site_early_stop_types : "code comes from"
  

```

```{mermaid}
%%| fig-cap: "Profile - Details"

erDiagram
  site ||--|{ disturbances : "has one or more"
  disturbances }|--|{ disturbance_types : "code comes from"
  disturbances }|--|{ disturbance_ages : "code comes from"
  site }|--|{ site_purposes : "code comes from"
  site }|--|{ site_selection_methods : "code comes from"
  site }|--|{ site_exposure_types : "code comes from"
  site }|--|{ site_early_stop_types : "code comes from"

  site {
    id          id_site                  "10.2.1"
    usr         usr_author               "10.2.2"
    geo         loc_site                 "10.2.3"
    dt          dt_site                  "10.2.4"
    cat         catu_site_purpose        "10.2.5"
    cat         catu_site_selection      "10.2.6"
    cat         catu_site_exposure       "10.2.7"
    num[0-1000] amt_site_depth_max_cm    "10.2.8"
    txt         catu_early_stop          "10.2.9"
  }
  
  site_purposes {
    id          id_site_purpose
    cat         catu_site_purpose        "Table 10.1"
    txt         txt_site_purpose         "Table 10.1"
  }
  
  site_selection_methods {
    id          id_site_selection
    cat         catu_site_selection      "Table 10.2"
    txt         txt_site_selection       "Table 10.2"
  }
  
  site_exposure_types {
    id          id_site_exposure
    cat         catu_site_exposure       "Table 10.3"
    txt         txt_site_exposure_name   "Table 10.3"
  }
  
  site_early_stop_types {
    id          id_site_stop
    cat         catu_site_stop           "Table 10.4"
    txt         txt_site_stop            "Table 10.4"
}
  
  disturbances {
    id          id_site
    id          id_disturbance
    txt         catu_disturbance         "Table 10.5"
    txt         catu_disturbance_age     "Table 10.6"
    num[0-Inf]  amt_disturbance_age_days "10.3"
  }

  disturbance_types {
    id          id_disturbance
    cat         catu_disturbance         "Table 10.5"
    txt         txt_disturbance_name     "Table 10.5"
    txt         txt_disturbance_desc     "Table 10.5"
  }
  
  disturbance_ages {
    id          id_disturbance_age
    cat         catu_disturbance_age     "Table 10.5"
    txt         txt_disturbance_age_name "Table 10.5"
    txt         txt_disturbance_age_desc "Table 10.5"
  }
  
```


## Soil Surface {#sec-erd-surface}

```{mermaid}
%%| fig-cap: "Surface - main tables only"

erDiagram
  site ||--|{ surface_cover : "has"
  site ||--o{ erosion : "may have"
  site ||--o{ deposition : "may have"

```

```{mermaid}
%%| fig-cap: "Surface - including support tables"

erDiagram
  site }|--|{ slope_methods : "code comes from"
  site }|--|{ measurement_types : "code comes from"
  site }|--|{ aspect_methods : "code comes from"
  site ||--|{ surface_cover : "has"
  surface_cover }|--|{ surface_cover_types : "code comes from"
  site }|--|{ surface_water_types : "code comes from"
  site }|--|{ surface_water_persts : "code comes from"
  site }|--|{ surface_crack_types : "code comes from"
  site }|--|{ surface_crack_shapes : "code comes from"
  site ||--o{ site_erosion : "may have"
  site }|--|{ site_microrelief_nat : "code comes from"
  site }|--|{ site_microrelief_ant : "code comes from"
  site_erosion }|--|{ erosion_types : "code comes from"
  site_erosion }|--|{ erosion_severity : "code comes from"
  site_erosion }|--|{ erosion_activity : "code comes from"
  site ||--o{ site_deposition : "may have"
  site_deposition }|--|{ deposition_types : "code comes from"
  site_deposition }|--|{ deposition_severity : "code comes from"
  site_deposition }|--|{ deposition_activity : "code comes from"
  

```

```{mermaid}
%%| fig-cap: "Surface - Details"

erDiagram
  site }|--|{ slope_methods : "code comes from"
  site }|--|{ measurement_types : "code comes from"
  site }|--|{ aspect_methods : "code comes from"
  site ||--|{ surface_cover : "has at least one"
  surface_cover }|--|{ surface_cover_types : "code comes from"
  site }|--|{ surface_water_types : "code comes from"
  site }|--|{ surface_water_persts : "code comes from"
  site }|--|{ surface_crack_types : "code comes from"
  site }|--|{ surface_crack_shapes : "code comes from"
  site ||--o{ site_erosion : "may have some"
  site }|--|{ site_microrelief_nat : "code comes from"
  site }|--|{ site_microrelief_ant : "code comes from"
  site_erosion }|--|{ erosion_types : "code comes from"
  site_erosion }|--|{ erosion_severity : "code comes from"
  site_erosion }|--|{ erosion_activity : "code comes from"
  site ||--o{ site_deposition : "may have some"
  site_deposition }|--|{ deposition_types : "code comes from"
  site_deposition }|--|{ deposition_severity : "code comes from"
  site_deposition }|--|{ deposition_activity : "code comes from"

  site {
    id          id_site                  "10.2.1"
    num[0-90]   amt_slope_d              "11.1"
    cat         catu_slope_rec           "Table D.1.1"
    cat         catu_slope_method        "Table 11.1"
    num[0-359]  amt_aspect_d             "11.2"
    cat         catu_aspect_rec          "Table D.1.1"
    cat         catu_aspect_method       "Table 11.2"
    cat         catu_surface_water       "11.4"
    cat         cato_surface_water_perst "11.4"
    cat         catu_surface_cracks      "11.5"
    cat         catu_surface_crack_shp   "11.5"
    cat         catu_microrelief_nat     "11.6.1"
    cat         catu_microrelief_ant     "11.6.2"
  }
  
  slope_methods {
    id          id_slope_method
    cat         catu_slope_method        "Table 11.1"
    txt         txt_slope_method_name    "Table 11.1"
    txt         txt_slope_method_desc    "Table 11.1"
  }
  
  aspect_methods {
    id          id_aspect_method
    cat         catu_aspect_method        "Table 11.2"
    txt         txt_aspect_method_name    "Table 11.2"
    txt         txt_aspect_method_desc    "Table 11.2"
  }
  
  measurement_types {
    id          id_mtype
    cat         catu_mtype
    txt         txt_mtype_name           "Table D1"
    txt         txt_mtype_desc           "Table D1"
  }

  surface_cover {
    id          id_site
    cat         catu_surface_cover       "11.3"
    num[0-100]  amt_surface_cover        "11.3"
  }
  
  surface_cover_types {
    id          id_surfcov
    cat         catu_surface_cover       "Table 11.3"
    txt         txt_surface_cover_name   "Table 11.3"
    txt         txt_surface_cover_desc   "Table 11.3"
  }
  
  surface_water_types {
    id          id_surface_water
    cat         catu_surface_water      "Table 11.4"
    txt         txt_surface_water_name  "Table 11.4"
    txt         txt_surface_water_desc  "Table 11.4"
  }

  surface_water_persts {
    id          id_surface_water_perst
    cat         catu_surface_water_perst       "Table 11.5"
    txt         txt_surface_water_perst_name   "Table 11.5"
    txt         txt_surface_water_perst_desc   "Table 11.5"
  }

  surface_crack_types {
    id          id_surface_crack
    cat         catu_surface_crack             "Table 11.6"
    txt         txt_surface_crack_name         "Table 11.6"
    txt         txt_surface_crack_desc         "Table 11.6"
  }
  
  surface_crack_shapes {
    id          id_surface_crack_shp
    cat         catu_surface_crack_shp         "Table 11.7"
    txt         txt_surface_crack_shp_name     "Table 11.7"
    txt         txt_surface_crack_shp_desc     "Table 11.7"
  }
  
  site_microrelief_nat {
    id          id_microrelief_nat
    cat         catu_microrelief_nat         "Table 11.8"
    txt         txt_microrelief_nat_name     "Table 11.8"
    txt         txt_microrelief_nat_desc     "Table 11.8"
  }
  
  site_microrelief_ant {
    id          id_microrelief_ant
    cat         catu_microrelief_ant         "Table 11.9"
    txt         txt_microrelief_ant_name     "Table 11.9"
    txt         txt_microrelief_ant_desc     "Table 11.9"
  }
  
  site_erosion {
    id          id_site
    id          id_erosion                   
    cat         catu_erosion                  
    cat         cato_erosion_severity
    cat         cato_erosion_activity
  }
  
  erosion_types {
    id          id_erosion
    cat         catu_erosion                   "Table 11.10"
    txt         txt_erosion_name               "Table 11.10"
    txt         txt_erosion_desc               "Table 11.10"
  }
  
  erosion_severity {
    id          id_erosion_severity
    cat         catu_erosion_severity          "Table 11.11"
    txt         txt_erosion_severity_name      "Table 11.11"
    txt         txt_erosion_severity_desc      "Table 11.11"
  }  
  
  erosion_activity {
    id          id_erosion_activity
    cat         catu_erosion_activity          "Table 11.12"
    txt         txt_erosion_activity_name      "Table 11.12"
    txt         txt_erosion_activity_desc      "Table 11.12"
  }  
  
 site_deposition {
    id          id_site
    id          id_deposition               
    cat         catu_deposition                   
    cat         cato_deposition_severity
    cat         cato_deposition_activity
  }
  
  deposition_types {
    id          id_deposition
    cat         catu_deposition                   "Table 11.13"
    txt         txt_deposition_name               "Table 11.13"
    txt         txt_deposition_desc               "Table 11.13"
  }  
  
  deposition_severity {
    id          id_deposition_severity
    cat         catu_deposition_severity          "Table 11.14"
    txt         txt_deposition_severity_name      "Table 11.14"
    txt         txt_deposition_severity_desc      "Table 11.14"
  }  
  
  deposition_activity {
    id          id_deposition_activity
    cat         catu_deposition_activity          "Table 11.15"
    txt         txt_deposition_activity_name      "Table 11.15"
    txt         txt_deposition_activity_desc      "Table 11.15"
  }  
```

## Horizon overview data {#sec-erd-horizon}

```{mermaid}
%%| fig-cap: "Horizon - main tables only"

erDiagram
  site ||--|{ horizon : "has at least one"

```

```{mermaid}
%%| fig-cap: "Horizon - including support tables"

erDiagram
  site ||--|{ horizon : "has at least one"
  site }|--|{ boundary_shapes : "code comes from"
  site }|--|{ boundary_widths : "code comes from"
  site }|--|{ soil_moistures : "code comes from"
  site }|--|{ water_depths : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon - Details"

erDiagram
  site ||--|{ horizon : "has at least one"
  site }|--|{ boundary_shapes : "code comes from"
  site }|--|{ boundary_widths : "code comes from"
  site }|--|{ soil_moistures : "code comes from"
  site }|--|{ water_depths : "code comes from"
  
  horizon {
  id         id_site
  id         id_horizon
  amt[0-Inf] amt_upper_depth_cm      "12.2"
  amt[0-Inf] amt_upper_depth_med_cm  "12.2"
  amt[0-Inf] amt_upper_depth_min_cm  "12.2"
  amt[0-Inf] amt_upper_depth_max_cm  "12.2"
  amt[0-Inf] amt_upper_depth_cm      "12.2"
  amt[0-Inf] amt_lower_depth_med_cm  "12.2"
  amt[0-Inf] amt_upper_depth_min_cm  "12.2"
  amt[0-Inf] amt_upper_depth_max_cm  "12.2"
  cat        catu_boundary_shape     "12.4"
  amt[0-Inf] amt_boundary_cm         "12.5"
  cat        catu_boundary_width     "12.5" 
  cat        cato_soil_moisture      "12.6"
  amt[0-Inf] amt_depth_water         "12.7"
  cat        catu_depth_water        "12.7"
  }
  
  boundary_shapes {
    id          id_boundary_shape
    cat         catu_boundary_shape          "Table 12.1"
    txt         txt_boundary_shape_name      "Table 12.1"
    txt         txt_boundary_shape_desc      "Table 12.1"
  }
 
  boundary_widths {
    id          id_boundary_width
    cat         catu_boundary_width          "Table 12.2"
    txt         txt_boundary_width_name      "Table 12.2"
    txt         txt_boundary_width_desc      "Table 12.2"
  } 
  
  soil_moistures {
    id          id_soil_moisture
    cat         catu_soil_moisture          "Table 12.3"
    txt         txt_soil_moisture_name      "Table 12.3"
  }
  
  water_depths {
    id          id_water_depths
    cat         catu_water_depths           "Table 12.4"
    txt         txt_water_depths_name       "Table 12.4"
    txt         txt_water_depths_desc       "Table 12.4"  
  }
```

## Horizon morphology data {#sec-erd-horizon}

```{mermaid}
%%| fig-cap: "Horizon morphology - main tables only"

erDiagram
  horizon ||--|{  : "has a"

```


```{mermaid}
%%| fig-cap: "Horizon morphology - including support tables"

erDiagram
  horizon ||--|{ horizon : "has at least one"

```

```{mermaid}
%%| fig-cap: "Horizon morphology - Details"

erDiagram
  horizon }|--|{ parent_material_origin : "code comes from"
  horizon }|--|{ parent_material_origin_mod : "code comes from"


  horizon {
  id         id_site
  id         id_horizon
  cat        catu_parent_material_origin    "13.7.1"
  cat        catu_anthropic_origin_modifier "13.7.1"
 
  
 parent_material_origin {
    id          id_pmo
    cat         catu_pmo           "Table 24.5"
    txt         txt_pmo_name       "Table 24.5"
    txt         txt_pmo_desc       "Table 24.5"  
  }
  
   parent_material_origin_mod {
    id          id_pmo_mod
    cat         catu_pmo_mod           "Table 13.1"
    txt         txt_pmo_mod_name       "Table 13.1"
    txt         txt_pmo_mod_desc       "Table 13.1"  
  }
```

## Sample data {#sec-erd-samples}

## Interpretation data {#sec-erd-interp}

