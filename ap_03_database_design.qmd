# Data model {#sec-erds}

```{r}
library(dplyr)
library(tibble)
library(gt)
library(gtExtras)
```

The following diagrams demonstrate one way in which the the contents of this manual can be structured in a database. The diagrams only deal with the data themselves - security, user management, change tracking and other helper functionalities are left out for clarity. Data tables for samples and laboratory results are also not included. The model is optimised to highlight the relationships between the various data points and contains some structures that support the controlled vocabulary lists, but is not optimised for performance. 

## Conceptual model

This overview shows the relationships between each part of the standard.

```{mermaid}
%%| fig-cap: "Overview - conceptual relationships"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  Site ||--|| Location : "has one"
  Site ||--|| Landform : "is in one"
  Site ||--|| Landscape : "is in one"
  Landscape ||--|{ Landform : "comprises at least one"
  Site ||--o{ "Recent events" : "may have some"
  Site ||--|| "Site surface" : "has one"
  "Site surface" ||--|{ "Surface cover" : "has"
  "Site surface" ||--o{ Erosion : "may have some"
  "Site surface" ||--o{ Deposition : "may have some"
  Site ||--|{ Horizon : "has at least one"
  Horizon ||--o{ "Peds" : "may contain"
  Horizon ||--o{ "Rock Fragments" : "may contain"
  Horizon ||--o{ "Other Fragments" : "may contain"
  Horizon ||--o{ "Artefacts" : "may contain"
  Horizon ||--o{ "Roots" : "may contain"
  Horizon ||--o{ "Voids" : "may contain"
  Horizon ||--o{ "Pores" : "may contain"
  Horizon ||--|{ "Matrix colour" : "has one or more"
  Horizon ||--o{ "Colour patterns" : "may have"
  Horizon ||--|| "Texture" : "has a"
  Horizon ||--|| "Particle size distribution (estimate)" : "has a"
  Horizon ||--o{ "Concentrations" : "may have some"
  Horizon ||--o{ "Coatings" : "may have some"
  Horizon ||--o{ "Pan" : "may be a"
  Horizon ||--o{ "Stress Features" : "may have some"
  Horizon ||--o{ "Biological features" : "may have some"
  Horizon ||--o{ "Consistence tests" : "may have some"
  Site ||--o{ "Field tests" : "may have some"
  Site ||--|{ "NZ Soil Classification" : "has an"
  Horizon ||--|| "Horizon Names" : "have"
  Horizon ||--|| "Functional Horizon Names" : "have"

```

## Soil Setting {#sec-erd-setting}

The setting tables store site location (@sec-loc), landscape and landform (@sec-gmph), land cover (@sec-lcov), and land use (@sec-luse).

```{mermaid}
%%| fig-cap: "Setting - Overview"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  site ||--|| location : "has one"
  location }|--|{ elevation_measurement_methods : "code comes from"
  location }|--|{ gnss_types : "code comes from"
  site ||--|| landscape : "has one associated"
  landscape }|--|{ provinces : "code comes from"
  landscape }|--|{ landscapes : "code comes from"
  landscape ||--|{ landform : "contains at least one"
  landscape ||--o{ lscape_landuse : "may have some"
  lscape_landuse }|--|{ landuse_primary : "code comes from"
  lscape_landuse }|--|{ landuse_secondary : "code comes from"
  landform }|--|{ landform_types : "code comes from"
  landform }|--|{ measurement_types : "code comes from"
  landform }|--|{ landform_elements : "code comes from"
  landform }|--|{ landform_element_vmods : "code comes from"
  landform }|--|{ landform_element_hmods : "code comes from"
  landform ||--o{ lform_landuse : "may have some"
  landform }|--|{ land_cover_types : "code comes from"
  lform_landuse }|--|{ landuse_primary : "code comes from"
  lform_landuse }|--|{ landuse_secondary : "code comes from"
  lform_landuse }|--|{ landuse_tertiary : "code comes from"

```

```{mermaid}
%%| fig-cap: "Setting - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  site ||--|| location : "has one"
  location }|--|{ elevation_measurement_methods : "code comes from"
  location }|--|{ gnss_types : "code comes from"
  site ||--|| landscape : "has one associated"
  landscape }|--|{ provinces : "code comes from"
  landscape }|--|{ landscapes : "code comes from"
  landscape ||--|{ landform : "contains at least one"
  landscape ||--o{ lscape_landuse : "may have some"
  lscape_landuse }|--|{ landuse_primary : "code comes from"
  lscape_landuse }|--|{ landuse_secondary : "code comes from"
  landform }|--|{ landform_types : "code comes from"
  landform }|--|{ measurement_types : "code comes from"
  landform }|--|{ landform_elements : "code comes from"
  landform }|--|{ landform_element_vmods : "code comes from"
  landform }|--|{ landform_element_hmods : "code comes from"
  landform ||--o{ lform_landuse : "may have some"
  landform }|--|{ land_cover_types : "code comes from"
  lform_landuse }|--|{ landuse_primary : "code comes from"
  lform_landuse }|--|{ landuse_secondary : "code comes from"
  lform_landuse }|--|{ landuse_tertiary : "code comes from"
  
  location {
    id           id_site                   
    geo          point_location            "Section 3.1.1"
    num[-5-3724] amt_elevation_abs_m       "Section 3.1.1"
    num[0-Inf]   amt_error_location_m      "Section 3.1.2"
    num[0-Inf]   amt_error_elevation_m     "Section 3.1.2"
    cat          catu_elevation_method     "Section 3.1.3"
    cat          catu_gnss                 "Section 3.1.4"
    num[-5-3724] amt_elevation_rel_m       "Section 3.2.1"
    txt          txt_notes_triangulation   "Section 3.2.2"
    txt          txt_location_desc         "Section 3.2.3"
    %% not defining code tables for these just now %%
    cat          catu_admin_rc             "Section 3.2.4"
    cat          catu_admin_dc             "Section 3.2.4"
  }
  
  elevation_measurement_methods {
    id           id_elevation_meas
    cat          catu_elevation_meas       "Table 3.1"
    txt          txt_elevation_meas_name   "Table 3.1"
    txt          txt_elevation_meas_desc   "Table 3.1"
  }

  gnss_types {
    id           id_gnss
    cat          catu_gnss_meas            "Table 3.2"
    txt          txt_gnss_meas_name        "Table 3.2"
    txt          txt_gnss_meas_desc        "Table 3.2"
  }  
  
  landscape {
    id id_site
    id id_landscape
    cat          catu_province             "Section 4.1"
    cat          catu_landscape            "Section 4.2.1.4"
    %% landscape relief %%
    num[0-Inf]   amt_lscape_relief_med_m   "Section 4.2.1.1"
    %% landscape slope %%
    num[0-90]    amt_lscape_slope_med_d    "Section 4.2.1.2"
    num[0-Inf]   amt_lscape_slope_min_d    "Section 4.2.1.2"
    num[0-Inf]   amt_lscape_slope_max_d    "Section 4.2.1.2"
    %% not implementing stream channel stuff here %%
  }

  provinces {
    id           id_province
    cat          catu_province             "Table 4.1"
    txt          txt_province_name         "Table 4.1"
    txt          txt_province_desc         "Note 4.1"
  }
  
  landscapes {
    id           id_landscape
    cat          catu_landscape            "Table 4.2"
    txt          txt_landscape_name        "Table 4.2"
    txt          txt_landscape_desc        "Table 4.2"
  }
  
  lscape_landuse {
    id           id_site
    id           id_landscape
    id           id_lscape_landuse
    cat          catu_lscape_landuse_primary
    cat          catu_lscape_landuse_secondary
    amt[0-100]   amt_landuse_area_p
  }

  landuse_primary {
    id           id_landuse_primary
    cat          catu_landuse_primary            "Fig. 8.1"
    txt          txt_landuse_primary_name        "Fig. 8.1"
    txt          txt_landuse_primary_desc        "Fig. 8.1"
  }

  landuse_secondary {
    id           id_landuse_primary
    cat          catu_landuse_primary            "Fig. 8.1"
    txt          txt_landuse_primary_name        "Fig. 8.1"
    txt          txt_landuse_primary_desc        "Fig. 8.1"
  }

  landform {
    id           id_site
    id           id_landscape
    id           id_landform
    cat          catu_landform              "Section 4.3.1"
    amt[0-100]   amt_landform_p             "Section 4.1.2.5"
    %% can only be true for one landform per site/landscape: %%
    bool         ind_landform_contains_site  
    %% (other way is separate tables for site-landform and    %%
    %% landscape-landforms)                                   %%
    cat          catu_land_cover            "Section 8.1"
    %% detailed optional stuff: %%
    num[0-Inf]   amt_landform_relief_m      "Section 4.3.2.1"
    num[0-90]    amt_landform_slope_med_d   "Section 4.3.2.2"
    num[0-Inf]   amt_landform_slope_min_d   "Section 4.3.2.2"
    num[0-Inf]   amt_landform_slope_max_d   "Section 4.3.2.2"
    num[0-359]   val_landform_aspect_med_d  "Section 4.3.2.3"
    num[0-359]   val_landform_aspect_min_d  "Section 4.3.2.3"
    num[0-359]   val_landform_aspect_max_d  "Section 4.3.2.3"
    cat          catu_landform_aspect_rec   "Table D.1.1"
    cat          cat_landform_element       "Section 4.3.2.4"
    cat          cat_landform_element_vmod  "Section 4.3.2.4"
    cat          cat_landform_element_hmod  "Section 4.3.2.4"
    %% extremely optional %%
    num[0-Inf]   amt_slope_length_m         "Section 4.4.1"
    num[-90-90]  amt_mesoscale_topo_index   "Section 4.4.2"
    num[-90-90]  amt_terrain_shape_index    "Section 4.4.3"
    
  }
  
  landform_types {
    id           id_landform
    cat          catu_landform              "Table 4.3"
    txt          txt_landform_name          "Table 4.3"
    txt          txt_landform_desc          "Table 4.3"
  }
  
  land_cover_types {
    id           id_land_cover
    cat          catu_land_cover              "Table 8.1"
    txt          txt_land_cover_name          "Table 8.1"
    txt          txt_land_cover_desc          "Table 8.1"
  }

  measurement_types {
    id          id_mtype
    cat         catu_mtype
    txt         txt_mtype_name              "Table D.1.1"
    txt         txt_mtype_desc              "Table D.1.1"
  }
  
  landform_elements {
    id          id_landform_element
    cat         catu_landform_element       "Table 4.4"
    txt         txt_landform_element_name   "Table 4.4"
    txt         txt_landform_element_desc   "Table 4.4"
  }
  
  landform_element_vmods {
    id          id_landform_element_vmod
    cat         catu_landform_element_vmod       "Table 4.5"
    txt         txt_landform_element_vmod_name   "Table 4.5"
    txt         txt_landform_element_vmod_desc   "Table 4.5"
  } 

  landform_element_hmods {
    id          id_landform_element_hmod
    cat         catu_landform_element_hmod       "Table 4.6"
    txt         txt_landform_element_hmod_name   "Table 4.6"
    txt         txt_landform_element_hmod_desc   "Table 4.6"
  } 

  lform_landuse {
    id           id_site
    id           id_landform
    id           id_lform_landuse
    cat          catu_lform_landuse_primary
    cat          catu_lform_landuse_secondary
    cat          catu_lform_landuse_tertiary
    amt[0-100]   amt_landuse_area_p
  }

  landuse_tertiary {
    id           id_landuse_tertiary
    cat          catu_landuse_tertiary            "Fig. 8.1"
    txt          txt_landuse_tertiary_name        "Fig. 8.1"
    txt          txt_landuse_tertiary_desc        "Fig. 8.1"
  }

```

## Site overview {#sec-erd-siteover}

The site table stores reference data (@sec-ref), except for location.

```{mermaid}
%%| fig-cap: "Site - Overview"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  site ||--|{ disturbances : "has one or more"
  disturbances }|--|{ disturbance_types : "code comes from"
  disturbances }|--|{ disturbance_ages : "code comes from"
  site }|--|{ site_purposes : "code comes from"
  site }|--|{ site_selection_methods : "code comes from"
  site }|--|{ site_exposure_types : "code comes from"
  site }|--|{ site_early_stop_types : "code comes from"
  

```

```{mermaid}
%%| fig-cap: "Site - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  site ||--|{ disturbances : "has one or more"
  disturbances }|--|{ disturbance_types : "code comes from"
  disturbances }|--|{ disturbance_ages : "code comes from"
  site }|--|{ site_purposes : "code comes from"
  site }|--|{ site_selection_methods : "code comes from"
  site }|--|{ site_exposure_types : "code comes from"
  site }|--|{ site_early_stop_types : "code comes from"

  site {
    id          id_site                  "10.2.1"
    usr         usr_author               "10.2.2"
    dt          dt_site                  "10.2.4"
    cat         catu_site_purpose        "10.2.5"
    cat         catu_site_selection      "10.2.6"
    cat         catu_site_exposure       "10.2.7"
    num[0-1000] amt_site_depth_max_cm    "10.2.8"
    txt         catu_early_stop          "10.2.9"
    %% weather at visit %%
    cat         catu_weather             "Section 6.3.1"
    num[-50-50] val_temperature_c        "Section 6.3.1"
    cat         cato_recent_rain         "Section 6.3.2"
    %% veg %%
    cat        cat_vegetation_luc        "Section 7.1"
    
  }
  
  site_purposes {
    id          id_site_purpose
    cat         catu_site_purpose        "Table 10.1"
    txt         txt_site_purpose         "Table 10.1"
  }
  
  site_selection_methods {
    id          id_site_selection
    cat         catu_site_selection      "Table 10.2"
    txt         txt_site_selection       "Table 10.2"
  }
  
  site_exposure_types {
    id          id_site_exposure
    cat         catu_site_exposure       "Table 10.3"
    txt         txt_site_exposure_name   "Table 10.3"
  }
  
  site_early_stop_types {
    id          id_site_stop
    cat         catu_site_stop           "Table 10.4"
    txt         txt_site_stop            "Table 10.4"
}
  
  disturbances {
    id          id_site
    id          id_disturbance
    txt         catu_disturbance         "Table 10.5"
    txt         catu_disturbance_age     "Table 10.6"
    num[0-Inf]  amt_disturbance_age_days "10.3"
  }

  disturbance_types {
    id          id_disturbance
    cat         catu_disturbance         "Table 10.5"
    txt         txt_disturbance_name     "Table 10.5"
    txt         txt_disturbance_desc     "Table 10.5"
  }
  
  disturbance_ages {
    id          id_disturbance_age
    cat         catu_disturbance_age     "Table 10.6"
    txt         txt_disturbance_age_name "Table 10.6"
    txt         txt_disturbance_age_desc "Table 10.6"
  }
  
```

## Surface {#sec-erd-surface}

The surface table stores slope, aspect, surface cover, surface water, surface cracking, microrelief, erosion and deposition data (@sec-pr-surface). It can also store LUC vegetation code (@sec-veg). This table can optionally extend the site table (@sec-erd-siteover) as it has a 1:1 relationship.

```{mermaid}
%%| fig-cap: "Surface - Overview"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  site_surface }|--|{ slope_methods : "code comes from"
  site_surface }|--|{ measurement_types : "code comes from"
  site_surface }|--|{ aspect_methods : "code comes from"
  site_surface ||--|{ surface_cover : "has"
  surface_cover }|--|{ surface_cover_types : "code comes from"
  site_surface }|--|{ surface_water_types : "code comes from"
  site_surface }|--|{ surface_water_persts : "code comes from"
  site_surface }|--|{ surface_crack_types : "code comes from"
  site_surface }|--|{ surface_crack_shapes : "code comes from"
  site_surface ||--o{ site_erosion : "may have"
  site_surface }|--|{ site_microrelief_nat : "code comes from"
  site_surface }|--|{ site_microrelief_ant : "code comes from"
  site_erosion }|--|{ erosion_types : "code comes from"
  site_erosion }|--|{ erosion_severity : "code comes from"
  site_erosion }|--|{ erosion_activity : "code comes from"
  site_surface ||--o{ site_deposition : "may have"
  site_deposition }|--|{ deposition_types : "code comes from"
  site_deposition }|--|{ deposition_severity : "code comes from"
  site_deposition }|--|{ deposition_activity : "code comes from"
  site_surface }|--|{ water_depths : "code comes from"
  site_surface }|--|{ luc_vegetation_codes : "code comes from"

```

```{mermaid}
%%| fig-cap: "Surface - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  site_surface }|--|{ slope_methods : "code comes from"
  site_surface }|--|{ measurement_types : "code comes from"
  site_surface }|--|{ aspect_methods : "code comes from"
  site_surface ||--|{ surface_cover : "has"
  surface_cover }|--|{ surface_cover_types : "code comes from"
  site_surface }|--|{ surface_water_types : "code comes from"
  site_surface }|--|{ surface_water_persts : "code comes from"
  site_surface }|--|{ surface_crack_types : "code comes from"
  site_surface }|--|{ surface_crack_shapes : "code comes from"
  site_surface ||--o{ site_erosion : "may have"
  site_surface }|--|{ site_microrelief_nat : "code comes from"
  site_surface }|--|{ site_microrelief_ant : "code comes from"
  site_erosion }|--|{ erosion_types : "code comes from"
  site_erosion }|--|{ erosion_severity : "code comes from"
  site_erosion }|--|{ erosion_activity : "code comes from"
  site_surface ||--o{ site_deposition : "may have"
  site_deposition }|--|{ deposition_types : "code comes from"
  site_deposition }|--|{ deposition_severity : "code comes from"
  site_deposition }|--|{ deposition_activity : "code comes from"
  site_surface }|--|{ water_depths : "code comes from"
  site_surface }|--|{ luc_vegetation_codes : "code comes from"

  site_surface {
    id          id_site                       "Section 10.2.1"
    num[0-90]   amt_slope_d                   "Section 11.1"
    cat         catu_slope_rec                "Table D.1.1"
    cat         catu_slope_method             "Table 11.1"
    num[0-359]  amt_aspect_d                  "Section 11.2"
    cat         catu_aspect_rec               "Table D.1.1"
    cat         catu_aspect_method            "Table 11.2"
    cat         catu_surface_water            "Section 11.4"
    cat         cato_surface_water_perst      "Section 11.4"
    cat         catu_surface_cracks           "Section 11.5"
    cat         catu_surface_crack_shp        "Section 11.5"
    cat         catu_microrelief_nat          "Section 11.6.1"
    %% optional details %%
    num[0-Inf]  amt_microrelief_nat_width_cm  "Section 11.6.1"
    num[0-Inf]  amt_microrelief_nat_height_cm "Section 11.6.1"
    cat         catu_microrelief_ant          "Section 11.6.2"
    %% optional details %%
    num[0-Inf]  amt_microrelief_ant_width_cm  "Section 11.6.1"
    num[0-Inf]  amt_microrelief_ant_height_cm "Section 11.6.1"
    amt[0-Inf]  amt_depth_water               "Section 12.7"
    cat         catu_depth_water              "Section 12.7"
    %% vegetation could also be stored at landscape and/or landform %%
    cat         catu_vegetation_luc           "Section 7.1"
  }
  
  slope_methods {
    id          id_slope_method
    cat         catu_slope_method        "Table 11.1"
    txt         txt_slope_method_name    "Table 11.1"
    txt         txt_slope_method_desc    "Table 11.1"
  }
  
  aspect_methods {
    id          id_aspect_method
    cat         catu_aspect_method        "Table 11.2"
    txt         txt_aspect_method_name    "Table 11.2"
    txt         txt_aspect_method_desc    "Table 11.2"
  }
  
  measurement_types {
    id          id_mtype
    cat         catu_mtype
    txt         txt_mtype_name           "Table D.1.1"
    txt         txt_mtype_desc           "Table D.1.1"
  }

  surface_cover {
    id          id_site
    cat         catu_surface_cover       "11.3"
    num[0-100]  amt_surface_cover        "11.3"
  }
  
  surface_cover_types {
    id          id_surfcov
    cat         catu_surface_cover       "Table 11.3"
    txt         txt_surface_cover_name   "Table 11.3"
    txt         txt_surface_cover_desc   "Table 11.3"
  }
  
  surface_water_types {
    id          id_surface_water
    cat         catu_surface_water      "Table 11.4"
    txt         txt_surface_water_name  "Table 11.4"
    txt         txt_surface_water_desc  "Table 11.4"
  }

  surface_water_persts {
    id          id_surface_water_perst
    cat         catu_surface_water_perst       "Table 11.5"
    txt         txt_surface_water_perst_name   "Table 11.5"
    txt         txt_surface_water_perst_desc   "Table 11.5"
  }

  surface_crack_types {
    id          id_surface_crack
    cat         catu_surface_crack             "Table 11.6"
    txt         txt_surface_crack_name         "Table 11.6"
    txt         txt_surface_crack_desc         "Table 11.6"
  }
  
  surface_crack_shapes {
    id          id_surface_crack_shp
    cat         catu_surface_crack_shp         "Table 11.7"
    txt         txt_surface_crack_shp_name     "Table 11.7"
    txt         txt_surface_crack_shp_desc     "Table 11.7"
  }
  
  site_microrelief_nat {
    id          id_microrelief_nat
    cat         catu_microrelief_nat         "Table 11.8"
    txt         txt_microrelief_nat_name     "Table 11.8"
    txt         txt_microrelief_nat_desc     "Table 11.8"
  }
  
  site_microrelief_ant {
    id          id_microrelief_ant
    cat         catu_microrelief_ant         "Table 11.9"
    txt         txt_microrelief_ant_name     "Table 11.9"
    txt         txt_microrelief_ant_desc     "Table 11.9"
  }
  
  site_erosion {
    id          id_site
    id          id_erosion                   
    cat         catu_erosion                  
    cat         cato_erosion_severity
    cat         cato_erosion_activity
  }
  
  erosion_types {
    id          id_erosion
    cat         catu_erosion                   "Table 11.10"
    txt         txt_erosion_name               "Table 11.10"
    txt         txt_erosion_desc               "Table 11.10"
  }
  
  erosion_severity {
    id          id_erosion_severity
    cat         catu_erosion_severity          "Table 11.11"
    txt         txt_erosion_severity_name      "Table 11.11"
    txt         txt_erosion_severity_desc      "Table 11.11"
  }  
  
  erosion_activity {
    id          id_erosion_activity
    cat         catu_erosion_activity          "Table 11.12"
    txt         txt_erosion_activity_name      "Table 11.12"
    txt         txt_erosion_activity_desc      "Table 11.12"
  }  
  
 site_deposition {
    id          id_site
    id          id_deposition               
    cat         catu_deposition                   
    cat         cato_deposition_severity
    cat         cato_deposition_activity
  }
  
  deposition_types {
    id          id_deposition
    cat         catu_deposition                   "Table 11.13"
    txt         txt_deposition_name               "Table 11.13"
    txt         txt_deposition_desc               "Table 11.13"
  }  
  
  deposition_severity {
    id          id_deposition_severity
    cat         catu_deposition_severity          "Table 11.14"
    txt         txt_deposition_severity_name      "Table 11.14"
    txt         txt_deposition_severity_desc      "Table 11.14"
  }  
  
  deposition_activity {
    id          id_deposition_activity
    cat         catu_deposition_activity          "Table 11.15"
    txt         txt_deposition_activity_name      "Table 11.15"
    txt         txt_deposition_activity_desc      "Table 11.15"
  }  
  
  water_depths {
    id          id_water_depths
    cat         catu_water_depths           "Table 12.4"
    txt         txt_water_depths_name       "Table 12.4"
    txt         txt_water_depths_desc       "Table 12.4"  
  }
 
  luc_vegetation_codes {
    id          id_vegetation_luc
    cat         catu_vegetation_luc           "Section 7.1"
    txt         txt_vegetation_luc_name       "Section 7.1"
    txt         txt_vegetation_luc_desc       "Section 7.1"  
  } 
```

## Horizon overview {#sec-erd-horizono}

The horizon overview table stores boundary definitions and soil moisture status at the time of examination. 

```{mermaid}
%%| fig-cap: "Horizon - including support tables"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon }|--|{ boundary_shapes : "code comes from"
  horizon }|--|{ boundary_widths : "code comes from"
  horizon }|--|{ soil_moistures : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon }|--|{ boundary_shapes : "code comes from"
  horizon }|--|{ boundary_widths : "code comes from"
  horizon }|--|{ soil_moistures : "code comes from"
  
  horizon {
  id         id_site
  id         id_horizon
  amt[0-Inf] amt_upper_depth_cm      "12.2"
  amt[0-Inf] amt_upper_depth_med_cm  "12.2"
  amt[0-Inf] amt_upper_depth_min_cm  "12.2"
  amt[0-Inf] amt_upper_depth_max_cm  "12.2"
  amt[0-Inf] amt_upper_depth_cm      "12.2"
  amt[0-Inf] amt_lower_depth_med_cm  "12.2"
  amt[0-Inf] amt_upper_depth_min_cm  "12.2"
  amt[0-Inf] amt_upper_depth_max_cm  "12.2"
  cat        catu_boundary_shape     "12.4"
  amt[0-Inf] amt_boundary_cm         "12.5"
  cat        catu_boundary_width     "12.5" 
  cat        cato_soil_moisture      "12.6"
  }
  
  boundary_shapes {
    id          id_boundary_shape
    cat         catu_boundary_shape          "Table 12.1"
    txt         txt_boundary_shape_name      "Table 12.1"
    txt         txt_boundary_shape_desc      "Table 12.1"
  }
 
  boundary_widths {
    id          id_boundary_width
    cat         catu_boundary_width          "Table 12.2"
    txt         txt_boundary_width_name      "Table 12.2"
    txt         txt_boundary_width_desc      "Table 12.2"
  } 
  
  soil_moistures {
    id          id_soil_moisture
    cat         catu_soil_moisture          "Table 12.3"
    txt         txt_soil_moisture_name      "Table 12.3"
  }
  
```

## Horizon architecture {#sec-erd-horizona}

The horizon architecture table stores parent material origin, as well as data about pedality, fragments, roots, voids and pores. This table can optionally extend the horizon overview table (@sec-erd-horizono) as it has a 1:1 relationship.

```{mermaid}
%%| fig-cap: "Horizon architecture - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram 
  horizon_arch ||--|{ horizon_peds : "may have"
  horizon_arch }|--|{ nzsc_parent_material_origin : "code comes from"
  horizon_arch }|--|{ parent_material_origin_mod : "code comes from"
  horizon_arch }|--|{ pedality_grades : "code comes from"
  horizon_arch }|--|{ ped_sizes_rapid : "code comes from"
  horizon_peds }|--|{ pedality_grades : "code comes from"
  horizon_peds }|--|{ ped_shapes : "code comes from"
  horizon_arch ||--|{ horizon_rock_fragments : "may have"
  horizon_rock_fragments }|--|{ fragment_sizes_simple : "code comes from"
  horizon_rock_fragments }|--|{ rock_fragment_shapes : "code comes from"
  horizon_rock_fragments }|--|{ nzsc_lithologies : "code comes from"
  horizon_arch ||--|{ horizon_other_fragments : "may have"
  horizon_other_fragments }|--|{ fragment_sizes_simple : "code comes from"
  horizon_other_fragments }|--|{ other_fragment_types : "code comes from"
  horizon_arch ||--|{ horizon_artefacts : "may have"
  horizon_artefacts }|--|{ fragment_sizes_simple : "code comes from"
  horizon_artefacts }|--|{ artefact_types: "code comes from"
  horizon_arch ||--|{ horizon_roots : "may have"
  horizon_arch }|--|{ root_positions: "code comes from"
  horizon_roots }|--|{ root_positions: "code comes from"
  horizon_roots }|--|{ root_sizes_simple: "code comes from"
  horizon_arch ||--|{ horizon_voids : "may have"
  horizon_voids }|--|{ void_types : "code comes from"
  horizon_voids }|--|{ void_conns : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon architecture - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_arch ||--|{ horizon_peds : "may have"
  horizon_arch }|--|{ nzsc_parent_material_origin : "code comes from"
  horizon_arch }|--|{ parent_material_origin_mod : "code comes from"
  horizon_arch }|--|{ pedality_grades : "code comes from"
  horizon_arch }|--|{ ped_sizes_rapid : "code comes from"
  horizon_peds }|--|{ pedality_grades : "code comes from"
  horizon_peds }|--|{ ped_shapes : "code comes from"
  horizon_arch ||--|{ horizon_rock_fragments : "may have"
  horizon_rock_fragments }|--|{ fragment_sizes_simple : "code comes from"
  horizon_rock_fragments }|--|{ rock_fragment_shapes : "code comes from"
  horizon_rock_fragments }|--|{ nzsc_lithologies : "code comes from"
  horizon_arch ||--|{ horizon_other_fragments : "may have"
  horizon_other_fragments }|--|{ fragment_sizes_simple : "code comes from"
  horizon_other_fragments }|--|{ other_fragment_types : "code comes from"
  horizon_arch ||--|{ horizon_artefacts : "may have"
  horizon_artefacts }|--|{ fragment_sizes_simple : "code comes from"
  horizon_artefacts }|--|{ artefact_types: "code comes from"
  horizon_arch ||--|{ horizon_roots : "may have"
  horizon_arch }|--|{ root_positions: "code comes from"
  horizon_roots }|--|{ root_positions: "code comes from"
  horizon_roots }|--|{ root_sizes_simple: "code comes from"
  horizon_arch ||--|{ horizon_voids : "may have"
  horizon_voids }|--|{ void_types : "code comes from"
  horizon_voids }|--|{ void_conns : "code comes from"
  
  horizon_arch {
    id         id_site
    id         id_horizon
    %% pmo %%
    cat        catu_parent_material_origin    "13.7.1"
    cat        catu_anthropic_origin_modifier "13.7.1"
    %% pedality rapid (detailed in subtable) %%
    cat        cato_pedality_grade            "14.1.1 (rapid)"
    cat        cato_ped_shape                 "14.1.2/3 (rapid)"
    cat        cato_ped_size                  "14.1.3 (rapid)"
    %% all frags super rapid (record this OR the next three) %%
    num[0-100] amt_total_frags_p               "14.2 (v. rapid)"
    %% rock frags rapid (detailed in subtable) %%
    num[0-100] amt_rockfrags_p                "14.2 (rapid)"
    %% notrock frags rapid %%
    num[0-100] amt_otherfrags_p               "14.2.1.1 (rapid)"
    %% notrock frags rapid %%
    num[0-100] amt_artefacts_p                "14.2.1.2 (rapid)"
    %% roots rapid %%
    num[0-100] amt_total_roots_p               "14.3.1 (rapid)"
    cat        catu_total_roots_pos            "14.3.2 (rapid)"
    %% void rapid %%
    num[0-100] amt_total_voids_p               "14.4 (rapid)"
    %% pores rapid %%
    num[0-10]  amt_total_pores_p               "14.5 (rapid)"
    %% pores detailed (could also spin out to subtable) %%
    num[0-10]  amt_macropores_p                "14.5"
    num[0-10]  amt_micropores_p                "14.5"
                  
  }
 
  nzsc_parent_material_origin {
    id          id_pmo
    cat         catu_pmo                "Table 24.5"
    txt         txt_pmo_name            "Table 24.5"
    txt         txt_pmo_desc            "Table 24.5"  
  }
  
  parent_material_origin_mod {
    id          id_pmo_mod
    cat         catu_pmo_mod            "Table 13.1"
    txt         txt_pmo_mod_name        "Table 13.1"
    txt         txt_pmo_mod_desc        "Table 13.1"  
  }

  pedality_grades {
    id          id_pedality_grade      
    cat         catu_pedality_grade         "Table 14.1"
    txt         txt_pedality_grade_name     "Table 14.1"
    txt         txt_pedality_grade_desc     "Table 14.1"
  }

  ped_sizes_rapid {
    id          id_ped_size_rapid       "14.1.3"
    cat         catu_ped_size_rapid     "C, F"
    txt         txt_ped_size_rapid_name "Coarse, Fine"
    txt         txt_ped_size_rapid_desc "> 40 mm, <= 40 mm"
  }
  
  horizon_peds {
    id id_site
    id id_horizon
    id id_ped
    cat        cato_pedality_grade            "14.1.1"
    cat        cato_ped_shape                 "14.1.2/3"
    amt[0-Inf] amt_ped_size_med_mm            "14.1.3" 
    amt[0-Inf] amt_ped_size_min_mm            "14.1.3" 
    amt[0-Inf] amt_ped_size_max_mm            "14.1.3"
  }
  

  ped_shapes {
    id          id_ped_shape     
    cat         catu_ped_shape           "Table 14.2/3"
    txt         txt_ped_shape_name       "Table 14.2/3"
    txt         txt_ped_shape_desc       "Table 14.2/3"
  }
  
  horizon_rock_fragments {
    id         id_site
    id         id_horizon
    id         id_rock_fragment
    cat        cato_rock_fragment_size        "Table 14.4"
    cat        catu_rock_fragment_shape       "Table 14.5"
    num[0-100] num_rock_fragment_p         
    cat        catu_rock_fragment_lithology   "Table 22.1"
  }
  
  fragment_sizes_simple {
    id          id_rockfrag_size     
    cat         catu_rockfrag_size            "Table 14.4"
    txt         txt_rockfrag_size_name        "Table 14.4"
    txt         txt_rockfrag_size_desc        "Table 14.4"
  }
  
  rock_fragment_shapes {
    id          id_rockfrag_shape     
    cat         catu_rockfrag_shape           "Table 14.5"
    txt         txt_rockfrag_shape_name       "Table 14.5"
    txt         txt_rockfrag_shape_desc       "Table 14.5"
  }
  
  nzsc_lithologies {
    id          id_nzsc_lithology     
    cat         catu_nzsc_lithology           "Table 24.2"
    txt         txt_nzsc_lithology_name       "Table 24.2"
  }
  
  %% %%
  horizon_other_fragments {
    id         id_site
    id         id_horizon
    id         id_other_fragment
    cat        cato_other_fragment_size       "Table 14.4"
    cat        cato_other_fragment            "Table 14.6"
    num[0-100] num_rock_fragment_p         
  }  
  
  other_fragment_types {
    id          id_other_fragment
    cat         cato_other_fragment           "Table 14.6"
    txt         txt_other_fragment_name       "Table 14.6"
    txt         txt_other_fragment_desc       "Table 14.6"
  }

  %% %%
  horizon_artefacts {
    id         id_site
    id         id_horizon
    id         id_artefact
    cat        cato_artefact_size           "Table 14.4"
    cat        cato_artefact                "Table 14.7"
    num[0-100] num_artefact_p         
  } 
  
  artefact_types {
    id          id_artefact
    cat         catu_artefact                "Table 14.7"
    txt         txt_artefact_type_name       "Table 14.7"
    txt         txt_artefact_type_desc       "Table 14.7"
  }
  
  %% %%
  horizon_roots {
    id         id_site
    id         id_horizon
    id         id_root
    cat        cato_root_size             "Table 14.8"
    cat        cato_root_pos              "Table 14.9"
    num[0-100] num_root_p         
  } 

  root_sizes_simple {
    id          id_root_size     
    cat         catu_root_size            "Table 14.8"
    txt         txt_root_size_name        "Table 14.8"
    txt         txt_root_size_desc        "Table 14.8"
  }
  
  root_positions {
    id          id_root_pos     
    cat         catu_root_pos            "Table 14.9"
    txt         txt_root_pos_name        "Table 14.9"
    txt         txt_root_pos_desc        "Table 14.9"
  }

  %% %%
  horizon_voids {
    id         id_site
    id         id_horizon
    id         id_void
    cat        catu_void                  "Table 14.10"
    cat        catu_void_conn             "Table 14.11"
    num[0-100] num_void_p         
  } 
  
  void_types {
    id          id_void  
    cat         catu_void                 "Table 14.10"
    txt         txt_void_name             "Table 14.10"
    txt         txt_void_desc             "Table 14.10"
  }  

  void_conns {
    id          id_void_conn  
    cat         catu_void_conn            "Table 14.10"
    txt         txt_void_conn_name        "Table 14.10"
    txt         txt_void_conn_desc        "Table 14.10"
  }  
  
```

## Horizon colour {#sec-erd-colour}

These tables store matrix colours (@sec-col-matrix) and colour patterns (@sec-col-patt).

```{mermaid}
%%| fig-cap: "Horizon colour - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon ||--|{ horizon_matrix_colours : "has one or more"
  horizon ||--|{ horizon_colour_patterns : "has one or more"
  horizon_matrix_colours }|--|{ munsell_colours : "code comes from"
  horizon_colour_patterns }|--|{ munsell_colours : "code comes from"
  horizon_colour_patterns }|--|{ short_colours : "code comes from"
  horizon_colour_patterns }|--|{ pattern_types : "code comes from"
  horizon_colour_patterns }|--|{ pattern_shapes : "code comes from"
  horizon_colour_patterns }|--|{ pattern_contrasts : "code comes from"
  horizon_colour_patterns }|--|{ pattern_edges : "code comes from"
```

```{mermaid}
%%| fig-cap: "Horizon colour - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon ||--|{ horizon_matrix_colours : "has one or more"
  horizon ||--|{ horizon_colour_patterns : "has one or more"
  horizon_matrix_colours }|--|{ munsell_colours : "code comes from"
  horizon_colour_patterns }|--|{ munsell_colours : "code comes from"
  horizon_colour_patterns }|--|{ short_colours : "code comes from"
  horizon_colour_patterns }|--|{ pattern_types : "code comes from"
  horizon_colour_patterns }|--|{ pattern_shapes : "code comes from"
  horizon_colour_patterns }|--|{ pattern_contrasts : "code comes from"
  horizon_colour_patterns }|--|{ pattern_edges : "code comes from"
  
  horizon_matrix_colours {
    id          id_site
    id          id_horizon
    id          id_colour_matrix           "Section 15.2"
    %% can also split into hue value chroma %%
    cat         catu_matrix_munsell        "Section 15.2"
    %% no simple colours on the matrix!! %%
    cat         catu_colour_moisture       "Section 15.2"
  }
  
  horizon_colour_patterns {
    id          id_site
    id          id_horizon
    id          id_colour_pattern
    %% either %%
    cat         catu_pattern_munsell    "Section 15.2"
    %% or, %%
    catu        catu_pattern_short_colour   "Section 15.1.1"
    cat         catu_pattern_type           "Section 15.3.1"
    amt[0-100]  amt_pattern_p               "Section 15.3.2"
    cat         catu_pattern_shape          "Section 15.3.3"
    amt[0-Inf]  amt_pattern_size_mm         "Section 15.3.4"
    cat         cato_pattern_contrast       "Section 15.3.5"
    cat         cato_pattern_edge           "Section 15.3.6"
   }
 
  munsell_colours {
    id          id_munsell
    cat         catu_munsell              "Table 15.2"
    %% optional but handy: %%
    txt         txt_colour_hex
  }  
   
  short_colours {
    id          id_colour
    cat         catu_colour               "Table 15.2"
    txt         txt_colour_name           "Table 15.2"
    txt         txt_colour_desc           "Table 15.2"
  } 

  pattern_types {
    id          id_pattern
    cat         catu_pattern              "Table 15.3"
    txt         txt_pattern_name          "Table 15.3"
    txt         txt_pattern_desc          "Table 15.3"
  } 

  pattern_shapes {
    id          id_pattern_shape
    cat         catu_pattern_shape        "Table 15.4"
    txt         txt_pattern_shape_name    "Table 15.4"
    txt         txt_pattern_shape_desc    "Table 15.4"
  }

  pattern_contrasts {
    id          id_pattern_contrast
    cat         catu_pattern_contrast     "Table 15.5"
    txt         txt_pattern_contrast_name "Table 15.5"
    txt         txt_pattern_contrast_desc "Table 15.5"
  }
  
  pattern_edges {
    id          id_pattern_edge
    cat         catu_pattern_edge         "Table 15.6"
    txt         txt_pattern_edge_name     "Table 15.6"
    txt         txt_pattern_edge_desc     "Table 15.6"
  }
```

## Horizon texture {#sec-erd-texture}

The horizon texture table stores texture category as well as field estimates of sand and clay. This table can optionally extend the horizon overview table (@sec-erd-horizono) as it has a 1:1 relationship.

```{mermaid}
%%| fig-cap: "Horizon texture - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_texture }|--|{ simple_textures : "code comes from"
  horizon_texture }|--|{ textures : "code comes from"
  horizon_texture }|--|{ sand_sizes : "code comes from"
  horizon_texture }|--|{ organic_levels : "code comes from"
  horizon_texture }|--|{ organic_decomps : "code comes from" 

```

```{mermaid}
%%| fig-cap: "Horizon colour - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_texture }|--|{ simple_textures : "code comes from"
  horizon_texture }|--|{ textures : "code comes from"
  horizon_texture }|--|{ sand_sizes : "code comes from"
  horizon_texture }|--|{ organic_levels : "code comes from"
  horizon_texture }|--|{ organic_decomps : "code comes from"
  
  horizon_texture {
    id          id_site
    id          id_horizon
    cat         catu_texture_simple     "Section 16.1.1"
    cat         catu_texture            "Section 16.1"
    cat         catu_sand_size_mod      "Section 16.2.1"
    cat         catu_organics           "Section 16.2.2"
    cat         catu_organics_decomp    "Section 16.2.2"
    amt[0-100]  amt_sand_est_med_p
    amt[0-100]  amt_sand_est_min_p
    amt[0-100]  amt_sand_est_max_p
    amt[0-100]  amt_clay_est_med_p
    amt[0-100]  amt_clay_est_min_p
    amt[0-100]  amt_clay_est_max_p
  }
   
  simple_textures {
    id          id_simple_texture
    cat         catu_simple_texture     "Table 16.3"
    txt         txt_simple_texture_name "Table 16.3"
    txt         txt_simple_texture_desc "Table 16.3"
  } 

  textures {
    id          id_texture
    cat         catu_texture            "Table 16.2"
    txt         txt_texture_name        "Table 16.2"
    txt         txt_texture_desc        "Table 16.2"
  } 

  sand_sizes {
    id          id_sand_size
    cat         catu_sand_size          "Table 16.4"
    txt         txt_sand_size_name      "Table 16.4"
    txt         txt_sand_size_desc      "Table 16.4"
  }

  organic_levels {
    id          id_organic
    cat         catu_organic            "Table 16.5"
    txt         txt_organic_name        "Table 16.5"
    txt         txt_organic_desc        "Table 16.5"
  }
  
  organic_decomps {
    id          id_organic_decomp
    cat         catu_organic_decomp     "Table 16.6"
    txt         txt_organic_decomp_name "Table 16.6"
    txt         txt_organic_decomp_desc "Table 16.6"
  }
```

## Horizon secondary features {#sec-erd-secf}

The secondary features tables stores essential information in a parent table and more detailed optional descriptions in child tables. The parent table can optionally extend the horizon overview table (@sec-erd-horizono) as it has a 1:1 relationship.

```{mermaid}
%%| fig-cap: "Horizon secondary features - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_secondary_features ||--o{ "horizon_concentrations" : "may have some"
  horizon_secondary_features ||--o{ "horizon_coatings" : "may have some"
  horizon_secondary_features ||--o{ "horizon_bio_features" : "may have some"
  horizon_secondary_features }|--|{ concentration_forms : "code comes from"
  horizon_secondary_features }|--|{ concentration_forms : "code comes from"
  horizon_secondary_features }|--|{ concentration_types : "code comes from"
  horizon_secondary_features }|--|{ pan_types : "code comes from"
  horizon_secondary_features }|--|{ pan_continuities : "code comes from"
  horizon_secondary_features }|--|{ pan_structures : "code comes from"
  horizon_secondary_features }|--|{ stress_types : "code comes from"
  horizon_concentrations }|--|{ concentration_forms : "code comes from"
  horizon_concentrations }|--|{ concentration_types : "code comes from"
  horizon_coatings }|--|{ coating_types : "code comes from"
  horizon_bio_features }|--|{ bio_feature_types : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon secondary features - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_secondary_features ||--o{ "horizon_concentrations" : "may have some"
  horizon_secondary_features ||--o{ "horizon_coatings" : "may have some"
  horizon_secondary_features ||--o{ "horizon_bio_features" : "may have some"
  horizon_secondary_features }|--|{ concentration_forms : "code comes from"
  horizon_secondary_features }|--|{ concentration_forms : "code comes from"
  horizon_secondary_features }|--|{ concentration_types : "code comes from"
  horizon_secondary_features }|--|{ pan_types : "code comes from"
  horizon_secondary_features }|--|{ pan_continuities : "code comes from"
  horizon_secondary_features }|--|{ pan_structures : "code comes from"
  horizon_secondary_features }|--|{ stress_types : "code comes from"
  horizon_concentrations }|--|{ concentration_forms : "code comes from"
  horizon_concentrations }|--|{ concentration_types : "code comes from"
  horizon_coatings }|--|{ coating_types : "code comes from"
  horizon_bio_features }|--|{ bio_feature_types : "code comes from"
  
  horizon_secondary_features {
    id          id_site
    id          id_horizon
    %% concentrations_rapid %%
    cat         catu_concentration_form "Section 17.1"
    amt[0-100]  amt_concentration_p     "Section 17.1"
    %% coatings rapid still has to go in a subtable see below %%
    %% rapid pans (you can only have one) %%
    cat         catu_pan_type                  "Section 17.3"
    %% add this stuff for details %%
    cat         cato_pan_continuity            
    cat         catu_pan_structure
    %% stress features (you get one or the other because Physics) %%
    cat         catu_stress_type
    amt[0-100]  amt_stress_p
    
  }
   
  horizon_concentrations {
    id          id_site
    id          id_horizon
    id          id_concentration
    cat         catu_concentration_form       "Table 17.1"
    cat         catu_concentration_type       "Table 17.2"
    num[0-Inf]  amt_concentration_size_med_mm
    num[0-Inf]  amt_concentration_size_min_mm
    num[0-Inf]  amt_concentration_size_max_mm
    num[0-Inf]  amt_concentration_med_p
    num[0-Inf]  amt_concentration_min_p
    num[0-Inf]  amt_concentration_max_p

  } 

  concentration_forms {
    id          id_conc_form
    cat         catu_conc_form            "Table 17.1"
    txt         txt_conc_form_name        "Table 17.1"
    txt         txt_conc_form_desc        "Table 17.1"
  }

  concentration_types {
    id          id_conc
    cat         catu_conc            "Table 17.2"
    txt         txt_conc_form_name   "Table 17.2"
    txt         txt_conc_form_desc   "Table 17.2"
  }

  pan_types {
    id          id_pan
    cat         catu_pan            "Table 17.4"
    txt         txt_pan_form_name   "Table 17.4"
    txt         txt_pan_form_desc   "Table 17.4"
  }

  pan_continuities {
    id          id_pan_cont
    cat         catu_pan_cont            "Table 17.5"
    txt         txt_pan_cont_name   "Table 17.5"
    txt         txt_pan_cont_desc   "Table 17.5"
  }

  pan_structures {
    id          id_pan_structure
    cat         catu_pan_structure          "Table 17.6"
    txt         txt_pan_structure_name "Table 17.6"
    txt         txt_pan_structure_desc "Table 17.6"
  }
  
  stress_types {
    id          id_stress
    cat         catu_stress            "Table 17.7"
    txt         txt_stress_name   "Table 17.7"
    txt         txt_stress_desc   "Table 17.7"
  }

  horizon_coatings {
    id          id_site
    id          id_horizon
    id          id_coating
    cat         catu_coating            "Table 17.3"
    amt[0-100]  amt_coating_p      
  } 

  coating_types {
    id          id_coating
    cat         catu_coating            "Table 17.3"
    txt         txt_coating_name        "Table 17.3"
    txt         txt_coating_desc        "Table 17.3"
  }

  horizon_bio_features {
    id          id_site
    id          id_horizon
    id          id_bio_feature
    cat         catu_bio_feature            "Table 17.8"
    amt[0-100]  amt_bio_feature_p     
  }

  bio_feature_types {
    id          id_bio_feature
    cat         catu_bio_feature            "Table 17.8"
    txt         txt_bio_feature_name        "Table 17.8"
    txt         txt_bio_feature_desc        "Table 17.8"
  }

```

## Horizon consistence Tests {#sec-erc-cons}

The consistence tests table can optionally extend the horizon overview table (@sec-erd-horizono) as it has a 1:1 relationship.

```{mermaid}
%%| fig-cap: "Horizon consistence tests - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  consistence_tests }|--|{ strengths : "code comes from"
  consistence_tests }|--|{ sensitivities : "code comes from"
  consistence_tests }|--|{ plasticities : "code comes from"
  consistence_tests }|--|{ stickinesses : "code comes from"
  consistence_tests }|--|{ penrests : "code comes from"
  consistence_tests }|--|{ packings : "code comes from"
  consistence_tests }|--|{ failures : "code comes from"
  consistence_tests }|--|{ fluidities : "code comes from"
  consistence_tests }|--|{ indurations : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon secondary features - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  consistence_tests }|--|{ strengths : "code comes from"
  consistence_tests }|--|{ sensitivities : "code comes from"
  consistence_tests }|--|{ plasticities : "code comes from"
  consistence_tests }|--|{ stickinesses : "code comes from"
  consistence_tests }|--|{ penrests : "code comes from"
  consistence_tests }|--|{ packings : "code comes from"
  consistence_tests }|--|{ failures : "code comes from"
  consistence_tests }|--|{ fluidities : "code comes from"
  consistence_tests }|--|{ indurations : "code comes from"
  
  consistence_tests {
    id          id_site
    id          id_horizon
    bool        ind_cohesive
    cat         cato_strength_unconfined
    cat         cato_strength_ped
    cat         cato_strength_remoulded
    cat         cato_strength_plastic
    cat         cato_sensitivity
    cat         cato_plasticity
    cat         cato_stickiness
    bool        ind_dilatent
    cat         cato_penetration_rest
    cat         cato_packing
    cat         catu_failure
    cat         cato_fluidity
    cat         catu_induration
  }

  strengths {
    id          id_strength
    cat         catu_strength            "Table 18.1"
    txt         txt_strength_name        "Table 18.1"
    txt         txt_strength_desc        "Table 18.1"
  }

  sensitivities {
    id          id_sensitivity
    cat         catu_sensitivity            "Table 18.2"
    txt         txt_sensitivity_name        "Table 18.2"
    txt         txt_sensitivity_desc        "Table 18.2"
  }

  plasticities {
    id          id_plasticity
    cat         catu_plasticity            "Table 18.3"
    txt         txt_plasticity_name        "Table 18.3"
    txt         txt_plasticity_desc        "Table 18.3"
  }

  stickinesses {
    id          id_stickiness
    cat         catu_stickiness            "Table 18.4"
    txt         txt_stickiness_name        "Table 18.4"
    txt         txt_stickiness_desc        "Table 18.4"
  }

  penrests {
    id          id_penrest
    cat         catu_penrest            "Table 18.5"
    txt         txt_penrest_name        "Table 18.5"
    txt         txt_penrest_desc        "Table 18.5"
  }

  packings {
    id          id_packing
    cat         catu_packing            "Table 18.6"
    txt         txt_packing_name        "Table 18.6"
    txt         txt_packing_desc        "Table 18.6"
  }

  failures {
    id          id_failure
    cat         catu_failure            "Table 18.7"
    txt         txt_failure_name        "Table 18.7"
    txt         txt_failure_desc        "Table 18.7"
  }
  
  fluidities {
    id          id_fluidity
    cat         catu_fluidity            "Table 18.8"
    txt         txt_fluidity_name        "Table 18.8"
    txt         txt_fluidity_desc        "Table 18.8"
  }  

  indurations {
    id          id_induration
    cat         catu_induration            "Table 18.9"
    txt         txt_induration_name        "Table 18.9"
    txt         txt_induration_desc        "Table 18.9"
  }    
  
```

## Field tests {#sec-erd-fts}

Field tests are conducted from samples taken at set depths so in this example are connected to sites rather than horizons. It is also possible to nest them within horizons.

```{mermaid}
%%| fig-cap: "Horizon field tests - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  field_tests }|--|{ pH_raupachs : "code comes from"
  field_tests }|--|{ h2o2_rxns : "code comes from"
  field_tests }|--|{ hcl_rxns : "code comes from"
  field_tests }|--|{ naf_rxns : "code comes from"
  field_tests }|--|{ slaking_rxns : "code comes from"
  field_tests }|--|{ dispersion_rxns : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon field tests - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  field_tests }|--|{ pH_raupachs : "code comes from"
  field_tests }|--|{ h2o2_rxns : "code comes from"
  field_tests }|--|{ hcl_rxns : "code comes from"
  field_tests }|--|{ naf_rxns : "code comes from"
  field_tests }|--|{ slaking_rxns : "code comes from"
  field_tests }|--|{ dispersion_rxns : "code comes from"
  
  field_tests {
    id          id_site
    num[0-Inf]  amt_test_depth_cm
    cat         cato_pH_raupach
    amt[0-14]   amt_pH_water
    amt[0-14]   amt_pH_h2o2
    cat         cato_h2o2_rxn
    amt[0-Inf]  amt_ec_dSm
    cat         cato_hcl_rxn
    bool        ind_mn_rxn
    cat         cato_naf_rxn
    bool        ind_22bip_rxn
    bool        ind_water_repellent
    cat         cato_slaking
    cat         cato_dispersion
  }

  pH_raupachs {
    id          id_raupach
    cat         catu_raupach           "2.0, 2.5 etc"
  }

  h2o2_rxns {
    id          id_h2o2_rxn
    cat         catu_h2o2_rxn            "Table 19.1"
    txt         txt_h2o2_rxn_name        "Table 19.1"
    txt         txt_h2o2_rxn_desc        "Table 19.1"
  }

  hcl_rxns {
    id          id_hcl_rxn
    cat         catu_hcl_rxn            "Table 19.2"
    txt         txt_hcl_rxn_name        "Table 19.2"
    txt         txt_hcl_rxn_desc        "Table 19.2"
  }

  naf_rxns {
    id          id_naf_rxn
    cat         catu_naf_rxn            "Table 19.3"
    txt         txt_naf_rxn_name        "Table 19.3"
    txt         txt_naf_rxn_desc        "Table 19.3"
  }

  slaking_rxns {
    id          id_slaking_rxn
    cat         catu_slaking_rxn            "Table 19.4"
    txt         txt_slaking_rxn_name        "Table 19.4"
    txt         txt_slaking_rxn_desc        "Table 19.4"
  }
  
  dispersion_rxns {
    id          id_dispersion_rxn
    cat         catu_dispersion_rxn            "Table 19.5"
    txt         txt_dispersion_rxn_name        "Table 19.5"
    txt         txt_dispersion_rxn_desc        "Table 19.5"
  }
  
```

## Interpretation data {#sec-erd-interp}

### NZSC {#sec-erd-nzsc}

```{mermaid}
%%| fig-cap: "Horizon field tests - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  nzsc }|--|{ nzsc_orders : "code comes from"
  nzsc }|--|{ nzsc_groups : "code comes from"
  nzsc }|--|{ nzsc_subgroups : "code comes from"
  nzsc }|--|{ nzsc_fam_profile_materials : "code comes from"
  nzsc }|--|{ nzsc_lithologies : "code comes from"
  nzsc }|--|{ nzsc_fam_textures : "code comes from"
  nzsc }|--|{ nzsc_fam_permeabilities : "code comes from"
  nzsc }|--|{ nzsc_fam_pm_origins : "code comes from"
  nzsc }|--|{ nzsc_sib_depths : "code comes from"
  nzsc }|--|{ nzsc_sib_tsstones : "code comes from"
  nzsc }|--|{ nzsc_sib_textures : "code comes from"
  nzsc }|--|{ nzsc_sib_drainages : "code comes from"
  nzsc }|--|{ nzsc_sib_drainage_mods : "code comes from"
  nzsc }|--|{ rooting_barriers : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon field tests - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  nzsc }|--|{ nzsc_orders : "code comes from"
  nzsc }|--|{ nzsc_groups : "code comes from"
  nzsc }|--|{ nzsc_subgroups : "code comes from"
  nzsc }|--|{ nzsc_fam_profile_materials : "code comes from"
  nzsc }|--|{ nzsc_lithologies : "code comes from"
  nzsc }|--|{ nzsc_fam_textures : "code comes from"
  nzsc }|--|{ nzsc_fam_permeabilities : "code comes from"
  nzsc }|--|{ nzsc_pm_origins : "code comes from"
  nzsc }|--|{ nzsc_sib_depths : "code comes from"
  nzsc }|--|{ nzsc_sib_tsstones : "code comes from"
  nzsc }|--|{ nzsc_sib_textures : "code comes from"
  nzsc }|--|{ nzsc_sib_drainages : "code comes from"
  nzsc }|--|{ drainage_mods : "code comes from"
  nzsc }|--|{ rooting_barriers : "code comes from"
  
  nzsc {
    id          id_site
    cat         catu_nzsc_order
    cat         catu_nzsc_group
    cat         catu_nzsc_subgroup
    cat         catu_nzsc_fam_profile_material "Section 24.1.1"
    cat         catu_nzsc_fam_stones_rock      "Section 24.1.2"
    cat         catu_nzsc_fam_fines_rock       "Section 24.1.2"
    cat         catu_nzsc_fam_texture          "Section 24.1.3"
    cat         catu_nzsc_fam_permeability     "Section 24.1.4"
    cat         catu_nzsc_fam_pm_origin        "Section 24.1.5"
    cat         catu_nzsc_sib_depth            "Section 24.2.1"
    cat         catu_nzsc_sib_tsstone          "Section 24.2.2"
    cat         catu_nzsc_sib_texture          "Section 24.2.3"
    cat         catu_nzsc_sib_drainage         "Section 24.2.4"
    cat         catu_nzsc_sib_drainage_mod     "Section 24.2.4.1"
    cat         catu_rooting_barrier           "Section 24.3.1"
    int[0-Inf]  val_rooting_barrier_horizon            
  }

  nzsc_orders {
    id          id_nzsc_order
    cat         catu_nzsc_order
    txt         txt_nzsc_order_name
    }

  nzsc_groups {
    id          id_nzsc_group
    cat         catu_nzsc_group
    txt         txt_nzsc_group_name
    }

  nzsc_subgroups {
    id          id_nzsc_subgroup
    cat         catu_nzsc_subgroup
    txt         txt_nzsc_subgroup_name
    }

  nzsc_fam_profile_materials {
    id          id_nzsc_fam_pm
    cat         catu_nzsc_fam_pm             "Table 24.1"
    txt         txt_nzsc_fam_pm_name         "Table 24.1"
    txt         txt_nzsc_fam_pm_desc         "Table 24.1"
    }

  nzsc_lithologies {
    id          id_nzsc_lithology     
    cat         catu_nzsc_lithology           "Table 24.2"
    txt         txt_nzsc_lithology_name       "Table 24.2"
  }
  
  nzsc_fam_textures {
    id          id_nzsc_fam_texture     
    cat         catu_nzsc_fam_texture           "Table 24.3"
    txt         txt_nzsc_fam_texture_name       "Table 24.3"
  }

  nzsc_fam_permeabilities {
    id          id_nzsc_fam_perm     
    cat         catu_nzsc_fam_perm           "Table 24.4"
    txt         txt_nzsc_fam_perm_name       "Table 24.4"
    txt         txt_nzsc_fam_perm_desc       "Table 24.4"
  }  
  
  nzsc_pm_origins {
    id          id_nzsc_pm_origin     
    cat         catu_nzsc_pm_origin           "Table 24.5"
    txt         txt_nzsc_pm_origin_name       "Table 24.5"
    txt         txt_nzsc_pm_origin_desc       "Table 24.5"

}

  nzsc_sib_depths {
    id          id_nzsc_sib_depth     
    cat         catu_nzsc_sib_perm           "Table 24.6"
    txt         txt_nzsc_sib_perm_name       "Table 24.6"
    txt         txt_nzsc_sib_perm_desc       "Table 24.6"
  }

  nzsc_sib_tsstones {
    id          id_nzsc_sib_tsstone     
    cat         catu_nzsc_sib_tsstone           "Table 24.7"
    txt         txt_nzsc_sib_tsstone_name       "Table 24.7"
    txt         txt_nzsc_sib_tsstone_desc       "Table 24.7"
  }

  nzsc_sib_textures {
    id          id_nzsc_sib_texture     
    cat         catu_nzsc_sib_texture           "Table 24.8"
    txt         txt_nzsc_sib_texture_name       "Table 24.8"
  }
  
  nzsc_sib_drainages {
    id          id_nzsc_sib_drainage     
    cat         catu_nzsc_sib_drainage          "Table 24.9"
    txt         txt_nzsc_sib_drainage_name      "Table 24.9"
    txt         txt_nzsc_sib_drainage_desc      "Table 24.9"
  }

  drainage_mods {
    id          id_drainage_mod    
    cat         catu_drainage_mod          "Table 24.10"
    txt         txt_drainage_mod_name      "Table 24.10"
    txt         txt_drainage_mod_desc      "Table 24.10"
  }
  
  rooting_barriers {
    id          id_rooting_barrier    
    cat         catu_rooting_barrier          "Table 24.11/12"
    txt         txt_rooting_barrier_name      "Table 24.11/12"
    txt         txt_rooting_barrier_desc      "Table 24.11/12"
  }
```

### Horizon names {#sec-erd-names}

The horizon names tables stores conventional and functional names. This table can optionally extend the horizon overview table as it has a 1:1 relationship (@sec-erd-horizono).

```{mermaid}
%%| fig-cap: "Horizon Names - table arrangement"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_names }|--|{ horizon_names_primary : "code comes from"
  horizon_names }|--|{ horizon_names_conventional : "code comes from"

```

```{mermaid}
%%| fig-cap: "Horizon names - Details"

%%{ init: { 'er': { 'layoutDirection': 'LR' } } }%%
erDiagram
  horizon_names }|--|{ horizon_names_primary : "code comes from"
  horizon_names }|--|{ horizon_names_conventional : "code comes from"
  horizon_names }|--|{ horizon_names_functional : "code comes from"
  horizon_names }|--|{ functional_horizon_permeabilities : "code comes from"
  
  horizon_names {
    id          id_site
    id          id_horizon
    %% for very rapid assessment %%
    cat         catu_horizon_primary   "Section 21.1.1"
    %% for full naming protocol %%
    cat         catu_horizon_name      "Sections 21.1.1-4"
    int[2-Inf]  val_lith_discont       "Section 21.1.5"
    int[2-Inf]  val_duplicate          "Section 21.1.6"
    bool        ind_buried             "Section 21.1.7"
    %% FH
    cat         catu_functional_name   "Section 21.2"
    cat         cato_functional_perm   "Section 21.2.1.8"
    bool        ind_topsoil            "Table 21.1"
    bool        ind_tephra_acid        "Table 21.2"
    bool        ind_tephra_basic       "Table 21.2"
  }

  horizon_names_primary {
    id          id_horizon_primary     
    cat         catu_horizon_primary           "Table 21.1"
    txt         txt_horizon_primary_name       "Table 21.1"
    txt         txt_horizon_primary_desc       "Table 21.1"
  }

  horizon_names_conventional {
    id          id_horizon_name_conv    
    cat         catu_horizon_name_conv           "Tables 21.2-9"
    txt         txt_horizon_name_conv_name       "Tables 21.2-9"
    txt         txt_horizon_name_conv_desc       "Tables 21.2-9"
  }

  horizon_names_functional {
    id          id_horizon_name_func    
    cat         catu_horizon_name_func           "Table 21.18"
    txt         txt_horizon_name_func_desc       "Table 21.18"
  }

  functional_horizon_permeabilities {
    id          id_horizon_perm    
    cat         cato_functional_perm           "Table 21.17"
    txt         txt_functional_perm_name       "Table 21.17"
    txt         txt_horizon_name_func_desc     "Table 21.17"
  }

```

::: {#nte-hzn .callout-note collapse="true" appearance="minimal" title="Storing conventional horizon names"}
Conventional horizon names in the New Zealand system are difficult to store in a structured manner due to the large number of ways the various components can be combined (@sec-hzn-conv). The following implementation, where the full list of 'legal' names (e.g. Ap, App, Apg, A/Bw ABw, etc) are anticipated and stored, is the simplest approach. It offers a compromise between ease of data entry and ease of querying, leaning more towards the former. 
:::

## Helper tables

### Measurement type

Some numeric parameters require a separate specification for types of missing data (e.g. aspect at the site, @sec-pr-aspect). These codes are built in to most categorical code lists in this standard (where it makes sense to include them). For numeric data, a companion text column is required. It is generally expected that it will be populated in a semi-automated manner - for each parameter, it should default to [NR]{.ceg}, and be automatically updated to [NM]{.ceg} if a value is supplied. Users may also update to [ND]{.ceg} as needed.

```{r}
#| label: tbl-missing
#| tbl-cap: "Data record type"

dat_ss_eventt <-
  tribble(~Code, ~Name,
            'NM', 'Parameter was recorded normally',
            'ND', 'Parameter could not be reliably determined or does not apply',
            'NR', 'Parameter was not recorded')

tbl_ss_eventt <- gt(dat_ss_eventt) |>
   tab_options(
    column_labels.font.weight = 'bold', 
    heading.title.font.weight = 'bold',
    table.align = 'center',
    table.width = '85%'
  ) |>
  tab_style(style = list(cell_text(color  = 'red', 
                                   weight = 'bold',
                                   align  = 'center')),
            locations = cells_body(columns = 1)) |>
  cols_width(Code ~pct(10))

tbl_ss_eventt
```
